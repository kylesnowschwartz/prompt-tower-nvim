# prompt-tower.nvim

A Neovim plugin for creating AI-ready context from your codebase. Inspired by the VSCode Prompt Tower extension.

## Features

- üìÅ **File Selection**: Choose files for context generation with UI interface or commands
- üé® **Multiple Template Formats**: XML, Markdown, and Minimal output formats with hot-swapping
- üå≥ **Project Tree Generation**: Configurable project structure visualization
- üìã **Clipboard Integration**: Automatically copy generated context to clipboard
- üö´ **Smart Ignore Patterns**: Respects .gitignore and .towerignore files
- ‚öôÔ∏è **Highly Configurable**: Extensive configuration options for all aspects
- üéØ **Workspace Detection**: Automatic project root detection
- ‚å®Ô∏è **Keyboard-Driven UI**: Intuitive keymaps for efficient file selection
- üß™ **Well Tested**: Comprehensive test suite using plenary.nvim

## Installation

### Using [lazy.nvim](https://github.com/folke/lazy.nvim)

```lua
{
  'kylesnowschwartz/prompt-tower-nvim',
  dependencies = {
    'nvim-lua/plenary.nvim', -- Required for file operations
  },
  config = function()
    require('prompt-tower').setup({
      -- Configuration options (see below)
    })
  end,
}
```

### Using [packer.nvim](https://github.com/wbthomason/packer.nvim)

```lua
use {
  'kylesnowschwartz/prompt-tower-nvim',
  requires = {
    'nvim-lua/plenary.nvim',
  },
  config = function()
    require('prompt-tower').setup()
  end
}
```

## Quick Start

1. **Select files for context**:

   ```vim
   :PromptTowerSelect  " Add current file to selection
   ```

2. **Generate and copy context**:

   ```vim
   :PromptTowerGenerate  " Generate context and copy to clipboard
   ```

3. **Clear selection**:
   ```vim
   :PromptTowerClear  " Remove all files from selection
   ```

## Commands

| Command                     | Description                          |
| --------------------------- | ------------------------------------ |
| `:PromptTower`              | Open file selection UI interface     |
| `:PromptTowerSelect`        | Add current file to selection        |
| `:PromptTowerGenerate`      | Generate context from selected files |
| `:PromptTowerClear`         | Clear all selected files             |
| `:PromptTowerToggle [file]` | Toggle file selection                |

### Additional Commands

You can also use the main `:PromptTower` command with subcommands:

```vim
:PromptTower ui          \" Open UI interface (default)
:PromptTower select      \" Add current file to selection
:PromptTower generate    \" Generate context
:PromptTower clear       \" Clear selections
:PromptTower format xml  \" Switch to XML template format
:PromptTower format markdown  \" Switch to Markdown template format
:PromptTower format minimal   \" Switch to minimal template format
```

## Configuration

Default configuration:

````lua
require('prompt-tower').setup({
  -- File discovery settings
  ignore_patterns = {
    '.git', 'node_modules', '.DS_Store', '*.pyc', '__pycache__',
    '.pytest_cache', '.venv', 'venv', 'target', 'build', 'dist',
    '.next', '.nuxt',
  },
  use_gitignore = true,
  use_towerignore = true,
  max_file_size_kb = 500, -- 500KB limit (matches VSCode default)

  -- Output format settings with template presets
  output_format = {
    -- Default template format
    default_format = 'xml', -- Options: 'xml', 'markdown', 'minimal'

    -- New format structure (recommended)
    block_template = '<file name="{fileNameWithExtension}" path="{rawFilePath}">\\n{fileContent}\\n</file>',
    block_separator = '\\n',
    block_trim_lines = true,

    wrapper_format = {
      template = '<context>\\n{githubIssues}{treeBlock}<project_files>\\n{blocks}\\n</project_files>\\n</context>',
    },

    -- Template presets
    presets = {
      xml = {
        block_template = '<file name="{fileNameWithExtension}" path="{rawFilePath}">\\n{fileContent}\\n</file>',
        separator = '\\n\\n',
        wrapper_template = '<!-- Generated by prompt-tower.nvim -->\\n<!-- {fileCount} files selected -->\\n\\n{treeBlock}<project_files>\\n{fileBlocks}\\n</project_files>',
      },
      markdown = {
        block_template = '## {fileName}\\n\\n**Path:** `{rawFilePath}`\\n\\n```{fileExtension}\\n{fileContent}\\n```',
        separator = '\\n\\n---\\n\\n',
        wrapper_template = '# Project Context\\n\\n{treeBlock}## Selected Files\\n\\n{fileBlocks}',
      },
      minimal = {
        block_template = '// File: {rawFilePath}\\n{fileContent}',
        separator = '\\n\\n',
        wrapper_template = '{fileBlocks}',
      },
    },
  },

  -- Project tree generation
  project_tree = {
    enabled = true,
    type = 'fullFilesAndDirectories', -- 'fullFilesAndDirectories', 'fullDirectoriesOnly', 'selectedFilesOnly', 'none'
    show_file_size = false,
    template = '<project_tree>\\n{projectTree}\\n</project_tree>\\n\\n',
  },

  -- Token counting (estimation)
  token_estimation = {
    chars_per_token = 4,
    show_warnings = true,
    warning_threshold = 8000,
  },

  -- UI settings
  ui = {
    border = 'rounded',
    width = 0.8,
    height = 0.8,
    title = 'Prompt Tower',
    show_help = true,
  },

  -- Keymaps for UI interface
  keymaps = {
    toggle_selection = '<Space>',
    select_all = 'A',
    clear_all = 'C',
    generate_context = '<CR>',
    quit = 'q',
    help = '?',
  },

  -- Clipboard settings
  clipboard = {
    register = '+', -- System clipboard
    notify_on_copy = true,
  },
})
````

### Template Formats

prompt-tower.nvim supports three built-in template formats that can be switched on-the-fly:

#### XML Format (Default)

```xml
<!-- Generated by prompt-tower.nvim -->
<!-- 2 files selected -->

<project_tree>
src/
‚îú‚îÄ‚îÄ main.lua
‚îî‚îÄ‚îÄ config.lua
</project_tree>

<project_files>
<file name="main.lua" path="src/main.lua">
-- Main application entry point
local M = {}
return M
</file>

<file name="config.lua" path="src/config.lua">
-- Configuration module
local config = {}
return config
</file>
</project_files>
```

#### Markdown Format

````markdown
# Project Context

<project_tree>
src/
‚îú‚îÄ‚îÄ main.lua
‚îî‚îÄ‚îÄ config.lua
</project_tree>

## Selected Files

## main.lua

**Path:** `src/main.lua`

```lua
-- Main application entry point
local M = {}
return M
```
````

---

## config.lua

**Path:** `src/config.lua`

```lua
-- Configuration module
local config = {}
return config
```

````

#### Minimal Format
```lua
// File: src/main.lua
-- Main application entry point
local M = {}
return M

// File: src/config.lua
-- Configuration module
local config = {}
return config
````

### UI Interface

The plugin provides a floating window interface for interactive file selection:

```vim
:PromptTower  \" Opens the UI interface
```

#### Default Keymaps

| Key       | Action                                 |
| --------- | -------------------------------------- |
| `<Space>` | Toggle file selection                  |
| `A`       | Select all files                       |
| `C`       | Clear all selections                   |
| `<CR>`    | Generate context and copy to clipboard |
| `q`       | Quit interface                         |
| `?`       | Show help                              |

These keymaps can be customized in the configuration under the `keymaps` section.

### File Ignore Patterns

prompt-tower.nvim supports multiple ways to exclude files from selection:

1. **Built-in ignore patterns**: Common patterns like `node_modules`, `.git`, etc.
2. **`.gitignore` files**: Respects project `.gitignore` files (when `use_gitignore = true`)
3. **`.towerignore` files**: Custom ignore patterns specific to Prompt Tower (when `use_towerignore = true`)

#### Using .towerignore

Create a `.towerignore` file in your project root with custom ignore patterns:

```gitignore
# Example .towerignore file

# Ignore test output files
test_output.log
*.log

# Ignore temporary editor files
*.swp
*.swo
*~

# Ignore large build artifacts
dist/
build/
target/

# Custom project-specific patterns
scratch/
temp/
docs/archive/
```

The `.towerignore` file uses the same syntax as `.gitignore` files and supports:

- Glob patterns (`*.log`, `temp*`)
- Directory patterns (`node_modules/`)
- Negation patterns (`!important.log`)
- Comments (`# This is a comment`)

## Development

### Requirements

- Neovim 0.8+
- [plenary.nvim](https://github.com/nvim-lua/plenary.nvim) for testing

### Running Tests

```bash
# Run all tests
make test

# Run specific test file
make test-file FILE=tests/config_spec.lua

# Check syntax and style
make lint

# Format code
make format
```

### Project Structure

```
prompt-tower-nvim/
‚îú‚îÄ‚îÄ lua/prompt-tower/
‚îÇ   ‚îú‚îÄ‚îÄ init.lua              # Main entry point
‚îÇ   ‚îú‚îÄ‚îÄ config.lua            # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ services/             # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_discovery.lua    # File scanning and filtering
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ template_engine.lua   # Context generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree_generator.lua    # Project tree creation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui.lua               # User interface
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workspace.lua        # Workspace management
‚îÇ   ‚îî‚îÄ‚îÄ models/               # Data structures
‚îÇ       ‚îî‚îÄ‚îÄ file_node.lua         # File tree node model
‚îú‚îÄ‚îÄ plugin/prompt-tower.lua   # Plugin registration
‚îú‚îÄ‚îÄ tests/                    # Comprehensive test suite
‚îî‚îÄ‚îÄ Makefile                  # Development tasks
```

## Roadmap

### Phase 1: MVP ‚úÖ

- [x] Basic plugin structure
- [x] Configuration system
- [x] File selection commands
- [x] Basic context generation
- [x] Test framework

### Phase 2: Core Features ‚úÖ

- [x] File discovery service with ignore patterns
- [x] Project tree generation with multiple formats
- [x] Template system with XML, Markdown, and Minimal formats
- [x] Template hot-swapping
- [x] Workspace detection and management
- [x] File node model with metadata
- [x] .towerignore support

### Phase 3: Enhanced UI ‚úÖ

- [x] Floating window UI interface
- [x] Keyboard-driven file selection
- [x] Visual tree display
- [x] Help system
- [x] Configurable keymaps

### Phase 4: Advanced Features (In Progress)

- [x] Token counting and estimation
- [x] Performance optimizations with lazy loading
- [ ] Telescope integration
- [ ] GitHub issues integration
- [ ] Multi-workspace support
- [ ] AI provider integration

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Make your changes and add tests
4. Run tests (`make test`)
5. Commit your changes (`git commit -m 'Add amazing feature'`)
6. Push to the branch (`git push origin feature/amazing-feature`)
7. Open a Pull Request

## License

MIT License - see LICENSE file for details.

## Acknowledgments

- Inspired by [Prompt Tower VSCode Extension](https://github.com/backnotprop/prompt-tower)
- Built with [plenary.nvim](https://github.com/nvim-lua/plenary.nvim)
- Follows [Neovim plugin development best practices](https://github.com/nanotee/nvim-lua-guide)
